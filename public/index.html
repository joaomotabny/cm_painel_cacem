<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #000; color: #fff; font-family: 'VT323', monospace; 
            margin: 0; padding: 15px; text-transform: uppercase;
            background-image: linear-gradient(0deg, transparent 50%, rgba(0,0,0,0.5) 50%), linear-gradient(90deg, rgba(255,255,255,0.05) 50%, transparent 50%);
            background-size: 3px 3px;
        }
        .header { font-size: 26px; color: #444; border-bottom: 2px solid #222; height: 35px; margin-bottom: 10px; }
        #clock { float: right; color: #ff9900; }
        .row { clear: both; font-size: 32px; border-bottom: 1px solid #111; height: 48px; line-height: 48px; display: flex; }
        .col-line { width: 15%; font-weight: bold; color: #ffff00; }
        .col-dest { width: 52%; color: #ccc; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .col-stop { width: 13%; color: #555; font-size: 20px; text-align: center; font-weight: bold; }
        .col-time { width: 20%; text-align: right; color: #ff9900; }
        
        @keyframes blinker { 50% { opacity: 0; } }
        .blink { animation: blinker 0.8s linear infinite; color: #ff3333; font-weight: bold; }
        .live { color: #50ff50; margin-right: 5px; font-size: 18px; }
    </style>
</head>
<body>
    <div class="header"><span>C. METROPOLITANA • INTERFACE CACÉM</span><span id="clock">00:00:00</span></div>
    <div id="list">A SINCRONIZAR PLATAFORMAS...</div>

    <script>
        function setClock() {
            var now = new Date();
            document.getElementById('clock').innerHTML = ("0" + now.getHours()).slice(-2) + ":" + ("0" + now.getMinutes()).slice(-2) + ":" + ("0" + now.getSeconds()).slice(-2);
        }

        async function getStopData(id) {
            try {
                const response = await fetch(`https://api.carrismetropolitana.pt/stops/${id}/realtime`);
                const data = await response.json();
                // Mapeia o ID para um nome curto (Ex: 170459 -> P459)
                return data.map(item => ({...item, stopLabel: 'P' + id.slice(-3)}));
            } catch (e) { return []; }
        }

        async function updateBoard() {
            const stopIds = ['170459', '172621']; 
            
            try {
                const results = await Promise.all(stopIds.map(id => getStopData(id)));
                let allDepartures = [].concat(...results);
                
                let html = '';
                const now = new Date();

                // Ordenação cronológica rigorosa
                allDepartures.sort((a, b) => (a.estimated_arrival_unix || a
