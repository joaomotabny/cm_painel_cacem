<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #000; color: #fff; font-family: 'VT323', monospace; 
            margin: 0; padding: 15px; text-transform: uppercase;
            background-image: linear-gradient(0deg, transparent 50%, rgba(0,0,0,0.5) 50%), linear-gradient(90deg, rgba(255,255,255,0.05) 50%, transparent 50%);
            background-size: 3px 3px;
        }
        .header { font-size: 24px; color: #444; border-bottom: 2px solid #222; height: 35px; margin-bottom: 15px; display: flex; justify-content: space-between; }
        #clock { color: #ff9900; }
        .row { clear: both; font-size: 34px; border-bottom: 1px solid #111; height: 50px; line-height: 50px; display: flex; align-items: center; }
        .col-line { width: 15%; font-weight: bold; color: #ffff00; }
        .col-dest { width: 65%; color: #ccc; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .col-time { width: 20%; text-align: right; color: #ff9900; font-weight: bold; }
        .live-icon { color: #50ff50; font-size: 16px; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <span>CacÃ©m - Av.Bons Amigos (sentido Belas)</span>
        <span id="clock">00:00:00</span>
    </div>
    <div id="list">A sintonizar percurso...</div>

    <script>
        function setClock() {
            var now = new Date();
            document.getElementById('clock').innerHTML = ("0" + now.getHours()).slice(-2) + ":" + ("0" + now.getMinutes()).slice(-2) + ":" + ("0" + now.getSeconds()).slice(-2);
        }

        function formatCMTime(timeStr) {
            if (!timeStr) return "--:--";
            let parts = timeStr.split(':');
            let hour = parseInt(parts[0]);
            if (hour >= 24) hour -= 24;
            return ("0" + hour).slice(-2) + ":" + parts[1];
        }

        async function updateBoard() {
            // IDs que definimos como os mais prÃ³ximos da Av. Bons Amigos/EstaÃ§Ã£o
            const stopIds = ['170459', '172500']; 
            try {
                const results = await Promise.all(stopIds.map(id => 
                    fetch(`https://api.carrismetropolitana.pt/stops/${id}/realtime`)
                    .then(res => res.json())
                ));
                
                let all = [].concat(...results);
                const nowUnix = Math.floor(Date.now() / 1000);

                // Filtrar por tempo (apenas futuro) e remover destinos que pareÃ§am errados (como Odivelas)
                let filtered = all.filter(d => {
                    const time = (d.estimated_arrival_unix || d.scheduled_arrival_unix);
                    const isFuture = time > nowUnix - 60;
                    // Filtro bÃ¡sico para evitar linhas que sabemos serem de direÃ§Ãµes opostas se necessÃ¡rio
                    const isNotOdivelas = !d.headsign.toLowerCase().includes("odivelas");
                    return isFuture && isNotOdivelas;
                });

                filtered.sort((a, b) => (a.scheduled_arrival_unix) - (b.scheduled_arrival_unix));

                let html = '';
                filtered.slice(0, 10).forEach(d => {
                    let rawTime = d.estimated_arrival || d.scheduled_arrival;
                    let displayTime = formatCMTime(rawTime);
                    const isLive = d.estimated_arrival ? '<span class="live-icon">ðŸ“¡</span>' : '';

                    html += `<div class="row">
                        <span class="col-line">${d.line_id}</span>
                        <span class="col-dest">${d.headsign}</span>
                        <span class="col-time">${displayTime}${isLive}</span>
                    </div>`;
                });

                document.getElementById('list').innerHTML = html || '<div class="row">Sem mais autocarros hoje</div>';
            } catch (e) {
                document.getElementById('list').innerHTML = "Erro de ligaÃ§Ã£o";
            }
        }

        setClock(); updateBoard();
        setInterval(setClock, 1000);
        setInterval(updateBoard, 30000);
    </script>
</body>
</html>
