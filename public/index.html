<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #000; color: #fff; font-family: 'VT323', monospace; 
            margin: 0; padding: 15px; text-transform: uppercase;
            background-image: linear-gradient(0deg, transparent 50%, rgba(0,0,0,0.5) 50%), linear-gradient(90deg, rgba(255,255,255,0.05) 50%, transparent 50%);
            background-size: 3px 3px;
        }
        .header { font-size: 24px; color: #333; border-bottom: 2px solid #222; height: 35px; }
        #clock { float: right; color: #eee; }
        .row { clear: both; font-size: 30px; border-bottom: 1px solid #111; height: 45px; line-height: 45px; }
        .col-line { float: left; width: 20%; font-weight: bold; color: #ffff00; text-shadow: 0 0 5px #ffff00; }
        .col-dest { float: left; width: 55%; color: #bbb; overflow: hidden; white-space: nowrap; }
        .col-time { float: left; width: 25%; text-align: right; color: #ff9900; }
        
        @keyframes blinker { 50% { opacity: 0; } }
        .blink { animation: blinker 0.8s linear infinite; color: #ff3333; }
        .schedule { color: #888; font-size: 24px; } /* Estilo para horário planeado */
    </style>
</head>
<body>
    <div class="header"><span>C. METROPOLITANA - CACÉM (1211)</span><span id="clock">00:00</span></div>
    <div id="list">A VERIFICAR HORÁRIOS...</div>

    <script>
        function setClock() {
            var now = new Date();
            document.getElementById('clock').innerHTML = ("0" + now.getHours()).slice(-2) + ":" + ("0" + now.getMinutes()).slice(-2);
        }

        async function updateBoard() {
            const stopId = '110543'; 
            // Vamos pedir o Tempo Real E o Planeado para garantir dados
            const urlReal = `https://api.carrismetropolitana.pt/stops/${stopId}/realtime`;

            try {
                const response = await fetch(urlReal);
                const departures = await response.json();
                
                let html = '';
                const now = new Date();

                // Filtrar para a 1211
                let filtered = departures.filter(d => d.line_id === '1211');
                
                // Ordenar por tempo
                filtered.sort((a, b) => (a.scheduled_arrival_unix || 0) - (b.scheduled_arrival_unix || 0));

                if (filtered.length === 0) {
                    html = '<div class="row" style="color:#666; font-size: 22px;">SEM SERVIÇO DE MOMENTO</div>';
                } else {
                    filtered.slice(0, 10).forEach(d => {
                        const unix = d.estimated_arrival_unix || d.scheduled_arrival_unix;
                        const arrivalTime = new Date(unix * 1000);
                        const diffMs = arrivalTime - now;
                        let diffMin = Math.floor(diffMs / 60000);

                        let timeText = diffMin + " MIN";
                        let isEstimated = d.estimated_arrival_unix ? "" : " (SCHED)";

                        if (diffMin <= 0) {
                            timeText = '<span class="blink">A CHEGAR</span>';
                        } else if (diffMin > 45) {
                            // Se faltar muito tempo, mostra a hora exata
                            timeText = ("0" + arrivalTime.getHours()).slice(-2) + ":" + ("0" + arrivalTime.getMinutes()).slice(-2);
                        }

                        html += `<div class="row">
                            <span class="col-line">${d.line_id}</span>
                            <span class="col-dest">${d.headsign.substring(0, 18)}</span>
                            <span class="col-time ${!d.estimated_arrival_unix ? 'schedule' : ''}">${timeText}</span>
                        </div>`;
                    });
                }

                document.getElementById('list').innerHTML = html;
            } catch (e) {
                document.getElementById('list').innerHTML = "ERRO NA LIGAÇÃO";
            }
        }

        setClock(); updateBoard();
        setInterval(setClock, 1000);
        setInterval(updateBoard, 30000);
    </script>
</body>
</html>
