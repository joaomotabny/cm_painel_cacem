<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #000; color: #fff; font-family: 'VT323', monospace; 
            margin: 0; padding: 15px; text-transform: uppercase;
            background-image: linear-gradient(0deg, transparent 50%, rgba(0,0,0,0.5) 50%), linear-gradient(90deg, rgba(255,255,255,0.05) 50%, transparent 50%);
            background-size: 3px 3px;
        }
        .header { font-size: 24px; color: #333; border-bottom: 2px solid #222; height: 35px; }
        #clock { float: right; color: #eee; }
        .row { clear: both; font-size: 34px; border-bottom: 1px solid #111; height: 52px; line-height: 52px; }
        .col-line { float: left; width: 18%; font-weight: bold; }
        .col-dest { float: left; width: 52%; color: #bbb; overflow: hidden; white-space: nowrap; }
        .col-plat { float: left; width: 10%; color: #ff9900; text-align: center; }
        .col-time { float: left; width: 20%; text-align: right; }
        .ap { color: #00ffff; text-shadow: 0 0 5px #00ffff; } 
        .ic { color: #ff3333; } 
        .u { color: #ffff00; }
        @keyframes blinker { 50% { opacity: 0; } }
        .blink { animation: blinker 0.8s linear infinite; color: #ff3333; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header"><span>CP LISBOA ORIENTE</span><span id="clock">00:00</span></div>
    <div id="list">A CARREGAR...</div>

    <script>
        function setClock() {
            var now = new Date();
            document.getElementById('clock').innerHTML = ("0" + now.getHours()).slice(-2) + ":" + ("0" + now.getMinutes()).slice(-2);
        }

        async function updateBoard() {
            // Usamos o AllOrigins mas no modo que o Mac prefere (Fetch)
            const target = 'https://servicos.infraestruturasdeportugal.pt/PandaServices/api/PARTIDASETXER/Oriente';
            const url = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}&_=${new Date().getTime()}`;

            try {
                const response = await fetch(url);
                const json = await response.json();
                const data = JSON.parse(json.contents);
                const comboios = data.Nodes || [];
                
                let html = '';
                const now = new Date();
                const nowTotalMin = (now.getHours() * 60) + now.getMinutes();

                comboios.slice(0, 10).forEach(c => {
                    const [hour, min] = c.Hora.split(':').map(Number);
                    let diff = (hour * 60 + min) - nowTotalMin;
                    
                    if (diff < -1000) diff += 1440;

                    let timeText = diff + " MIN";
                    if (diff <= 0) timeText = '<span class="blink">PARTIDA</span>';

                    let service = c.Servico;
                    let cClass = 'col-line';
                    if (service === 'Alfa' || service === 'AP') cClass += ' ap';
                    else if (service === 'IC') cClass += ' ic';
                    else if (service === 'Urb' || service === 'Subu') { service = 'URB'; cClass += ' u'; }

                    html += `<div class="row">
                        <span class="${cClass}">${service}</span>
                        <span class="col-dest">${c.Destino.substring(0, 14)}</span>
                        <span class="col-plat">${c.Linha || '-'}</span>
                        <span class="col-time">${timeText}</span>
                    </div>`;
                });
                document.getElementById('list').innerHTML = html || "SEM COMBOIOS AGORA";
            } catch (e) {
                document.getElementById('list').innerHTML = "ERRO NA LIGAÇÃO";
            }
        }

        setClock(); updateBoard();
        setInterval(setClock, 1000);
        setInterval(updateBoard, 30000);
    </script>
</body>
</html>
