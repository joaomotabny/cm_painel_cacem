<script>
    async function update() {
        const list = document.getElementById('list');
        try {
            // Adicionamos um cabeçalho para o iPad mini não ser bloqueado
            const r = await fetch('https://api.carrismetropolitana.pt/stops/172500/estimations', {
                method: 'GET',
                mode: 'cors'
            });
            
            if (!r.ok) throw new Error('Carris em baixo');
            
            const data = await r.json();
            list.innerHTML = '';
            
            if (!data || data.length === 0) {
                list.innerHTML = '<div class="row"><span>SEM AUTOCARROS</span></div>';
                return;
            }

            // Ordenamos por tempo de espera para garantir que os próximos aparecem primeiro
            data.sort((a, b) => a.wait_time - b.wait_time);

            data.slice(0, 5).forEach(bus => {
                list.innerHTML += `
                    <div class="row">
                        <span class="line">${bus.line_id}</span>
                        <span style="flex-grow:1; margin-left:15px">${bus.headsign.substring(0,10)}</span>
                        <span class="time">${bus.wait_time}m</span>
                    </div>`;
            });
        } catch (e) {
            // Se falhar, tentamos mostrar o que correu mal
            list.innerHTML = '<div class="row" style="font-size:30px">ERRO DE DADOS: ' + e.message + '</div>';
        }
    }

    // Relógio (que já disseste que funciona!)
    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    }, 1000);

    update();
    setInterval(update, 30000); // Atualiza a cada 30 segundos
</script>
